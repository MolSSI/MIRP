/*! \file
 *
 * \brief Some miscellaneous mathematical functions in double
 *        precision and arbitrary precision
 */

#include "mirp/math.h"
#include <assert.h>

#define MIRP_MAX_FAC_INT 20
#define MIRP_MAX_FAC_DBL 170
#define MIRP_MAX_DFAC_INT 34
#define MIRP_MAX_DFAC_DBL 301

static const uint64_t fac_int_lut_[21] = {
1, 1, 2, 6, 24, 120, 720, 5040, 40320, 362880, 3628800, 39916800, 479001600, 6227020800, 87178291200,
1307674368000, 20922789888000, 355687428096000, 6402373705728000, 121645100408832000, 2432902008176640000 };

static const double fac_double_lut_[171] = {
1.000000000000000000e+00, 1.000000000000000000e+00, 2.000000000000000000e+00, 6.000000000000000000e+00, 2.400000000000000000e+01,
1.200000000000000000e+02, 7.200000000000000000e+02, 5.040000000000000000e+03, 4.032000000000000000e+04, 3.628800000000000000e+05,
3.628800000000000000e+06, 3.991680000000000000e+07, 4.790016000000000000e+08, 6.227020800000000000e+09, 8.717829120000000000e+10,
1.307674368000000000e+12, 2.092278988800000000e+13, 3.556874280960000000e+14, 6.402373705728000000e+15, 1.216451004088320000e+17,
2.432902008176640000e+18, 5.109094217170944000e+19, 1.124000727777607680e+21, 2.585201673888497821e+22, 6.204484017332394100e+23,
1.551121004333098606e+25, 4.032914611266056503e+26, 1.088886945041835194e+28, 3.048883446117138719e+29, 8.841761993739701899e+30,
2.652528598121910682e+32, 8.222838654177922430e+33, 2.631308369336935178e+35, 8.683317618811885939e+36, 2.952327990396041573e+38,
1.033314796638614543e+40, 3.719933267899012549e+41, 1.376375309122634558e+43, 5.230226174666011171e+44, 2.039788208119744412e+46,
8.159152832478976838e+47, 3.345252661316380796e+49, 1.405006117752879955e+51, 6.041526306337383407e+52, 2.658271574788448869e+54,
1.196222208654801886e+56, 5.502622159812089154e+57, 2.586232415111681777e+59, 1.241391559253607253e+61, 6.082818640342675225e+62,
3.041409320171337558e+64, 1.551118753287382189e+66, 8.065817517094387685e+67, 4.274883284060025485e+69, 2.308436973392413792e+71,
1.269640335365827645e+73, 7.109985878048634810e+74, 4.052691950487721410e+76, 2.350561331282878495e+78, 1.386831185456898386e+80,
8.320987112741389895e+81, 5.075802138772248358e+83, 3.146997326038793939e+85, 1.982608315404440085e+87, 1.268869321858841654e+89,
8.247650592082471517e+90, 5.443449390774430694e+92, 3.647111091818868322e+94, 2.480035542436830548e+96, 1.711224524281412974e+98,
1.197857166996989221e+100, 8.504785885678623005e+101, 6.123445837688608464e+103, 4.470115461512684386e+105, 3.307885441519386242e+107,
2.480914081139539975e+109, 1.885494701666050381e+111, 1.451830920282858721e+113, 1.132428117820629679e+115, 8.946182130782975714e+116,
7.156945704626380571e+118, 5.797126020747367841e+120, 4.753643337012842020e+122, 3.945523969720658788e+124, 3.314240134565353194e+126,
2.817104114380550131e+128, 2.422709538367273413e+130, 2.107757298379527854e+132, 1.854826422573984361e+134, 1.650795516090846024e+136,
1.485715964481761515e+138, 1.352001527678402916e+140, 1.243841405464130818e+142, 1.156772507081641566e+144, 1.087366156656743075e+146,
1.032997848823905930e+148, 9.916779348709496478e+149, 9.619275968248212038e+151, 9.426890448883247984e+153, 9.332621544394415325e+155,
9.332621544394415097e+157, 9.425947759838359882e+159, 9.614466715035127079e+161, 9.902900716486180472e+163, 1.029901674514562810e+166,
1.081396758240290977e+168, 1.146280563734708368e+170, 1.226520203196138005e+172, 1.324641819451829018e+174, 1.443859583202493662e+176,
1.588245541522743029e+178, 1.762952551090244587e+180, 1.974506857221074012e+182, 2.231192748659813766e+184, 2.543559733472187655e+186,
2.925093693493015997e+188, 3.393108684451898086e+190, 3.969937160808721062e+192, 4.684525849754290924e+194, 5.574585761207605823e+196,
6.689502913449127121e+198, 8.094298525273444092e+200, 9.875044200833601058e+202, 1.214630436702532930e+205, 1.506141741511140931e+207,
1.882677176888926113e+209, 2.372173242880046851e+211, 3.012660018457659431e+213, 3.856204823625804072e+215, 4.974504222477287459e+217,
6.466855489220474147e+219, 8.471580690878820631e+221, 1.118248651196004330e+224, 1.487270706090685713e+226, 1.992942746161518793e+228,
2.690472707318050407e+230, 3.659042881952548864e+232, 5.012888748274991961e+234, 6.917786472619488581e+236, 9.615723196941089353e+238,
1.346201247571752574e+241, 1.898143759076170890e+243, 2.695364137888162853e+245, 3.854370717180073079e+247, 5.550293832739304439e+249,
8.047926057471991706e+251, 1.174997204390910710e+254, 1.727245890454638923e+256, 2.556323917872865393e+258, 3.808922637630569789e+260,
5.713383956445854684e+262, 8.627209774233239986e+264, 1.311335885683452449e+267, 2.006343905095682295e+269, 3.089769613847350776e+271,
4.789142901463394078e+273, 7.471062926282894223e+275, 1.172956879426414474e+278, 1.853271869493734989e+280, 2.946702272495038403e+282,
4.714723635992061610e+284, 7.590705053947218993e+286, 1.229694218739449418e+289, 2.004401576545302627e+291, 3.287218585534295909e+293,
5.423910666131588675e+295, 9.003691705778437545e+297, 1.503616514864999146e+300, 2.526075744973198422e+302, 4.269068009004705108e+304,
7.257415615307999035e+306 };

static const uint64_t dfac_int_lut_[35] = {
1, 1, 1, 2, 3, 8, 15, 48, 105, 384, 945, 3840, 10395, 46080, 135135, 645120, 2027025, 10321920, 34459425, 185794560,
654729075, 3715891200, 13749310575, 81749606400, 316234143225, 1961990553600, 7905853580625, 51011754393600, 213458046676875,
1428329123020800, 6190283353629375, 42849873690624000, 191898783962510625, 1371195958099968000, 6332659870762850625}; // close dfac_int

static const double dfac_double_lut_[302] = {
1.000000000000000000e+00, 1.000000000000000000e+00, 1.000000000000000000e+00, 2.000000000000000000e+00, 3.000000000000000000e+00,
8.000000000000000000e+00, 1.500000000000000000e+01, 4.800000000000000000e+01, 1.050000000000000000e+02, 3.840000000000000000e+02,
9.450000000000000000e+02, 3.840000000000000000e+03, 1.039500000000000000e+04, 4.608000000000000000e+04, 1.351350000000000000e+05,
6.451200000000000000e+05, 2.027025000000000000e+06, 1.032192000000000000e+07, 3.445942500000000000e+07, 1.857945600000000000e+08,
6.547290750000000000e+08, 3.715891200000000000e+09, 1.374931057500000000e+10, 8.174960640000000000e+10, 3.162341432250000000e+11,
1.961990553600000000e+12, 7.905853580625000000e+12, 5.101175439360000000e+13, 2.134580466768750000e+14, 1.428329123020800000e+15,
6.190283353629375000e+15, 4.284987369062400000e+16, 1.918987839625106240e+17, 1.371195958099968000e+18, 6.332659870762850304e+18,
4.662066257539891200e+19, 2.216430954766997586e+20, 1.678343852714360832e+21, 8.200794532637891887e+21, 6.377706640314571162e+22,
3.198309867728777521e+23, 2.551082656125828465e+24, 1.311307045768798777e+25, 1.071454715572847955e+26, 5.638620296805835128e+26,
4.714400748520531003e+27, 2.537379133562625581e+28, 2.168624344319444393e+29, 1.192568192774434173e+30, 1.040939685273333196e+31,
5.843584144594727079e+31, 5.204698426366666251e+32, 2.980227913743310720e+33, 2.706443181710666537e+34, 1.579520794283954682e+35,
1.461479318123759847e+36, 8.687364368561751230e+36, 8.184284181493055615e+37, 4.951797690080197941e+38, 4.746884825265972049e+39,
2.921560637147317125e+40, 2.848130895159583350e+41, 1.782151988659863442e+42, 1.765841154998941530e+43, 1.122755752855713841e+44,
1.130138339199322579e+45, 7.297912393562140345e+45, 7.458913038715528897e+46, 4.889601303686633866e+47, 5.072060866326560258e+48,
3.373824899543777506e+49, 3.550442606428592155e+50, 2.395415678676082045e+51, 2.556318676628586484e+52, 1.748653445433539826e+53,
1.891675820705153881e+54, 1.311490084075154804e+55, 1.437673623735916909e+56, 1.009847364737869280e+57, 1.121385426514015220e+58,
7.977794181429167246e+58, 8.971083412112120864e+59, 6.462013286957625447e+60, 7.356288397931939751e+61, 5.363471028174829207e+62,
6.179282254262829482e+63, 4.558950373948604935e+64, 5.314182738666033004e+65, 3.966286825335286481e+66, 4.676480810026109343e+67,
3.529995274548404841e+68, 4.208832729023498037e+69, 3.212295699839048132e+70, 3.872126110701618532e+71, 2.987435000850314990e+72,
3.639798544059521243e+73, 2.838063250807799036e+74, 3.494206602297140393e+75, 2.752921353283565241e+76, 3.424322470251197409e+77,
2.725392139750729466e+78, 3.424322470251197347e+79, 2.752646061148236584e+80, 3.492808919656221373e+81, 2.835225442982683882e+82,
3.632521276442470363e+83, 2.976986715131817968e+84, 3.850472553029018595e+85, 3.185375785191045221e+86, 4.158510357271340138e+87,
3.472059605858239380e+88, 4.574361392998474364e+89, 3.853986162502645683e+90, 5.123284760158291288e+91, 4.355004363627989454e+92,
5.840544626580451445e+93, 5.008255018172188191e+94, 6.775031766833323899e+95, 5.859658371261459880e+96, 7.994537484863322628e+97,
6.972993461801137105e+98, 9.593444981835986668e+99, 8.437322088779376116e+100, 1.170400287783990494e+102, 1.037790616919863397e+103,
1.451296356852148193e+104, 1.297238271149829080e+105, 1.828633409633706633e+106, 1.647492604360283066e+107, 2.340650764331144491e+108,
2.125265459624765286e+109, 3.042845993630488120e+110, 2.784097752108442136e+111, 4.016556711592243944e+112, 3.702850010304228351e+113,
5.382185993533606526e+114, 4.998847513910708055e+115, 7.319772951205705138e+116, 6.848421094057670473e+117, 1.010128667266387247e+119,
9.519305320740162058e+119, 1.414180134172942311e+121, 1.342222050224362794e+122, 2.008135790525577972e+123, 1.919377531820838801e+124,
2.891715538356832233e+125, 2.783097421140216126e+126, 4.221904686000975255e+127, 4.091153209076117885e+128, 6.248418935281442993e+129,
6.095818281523415264e+130, 9.372628402922165598e+131, 9.204685605100357128e+132, 1.424639517244169171e+134, 1.408316897580354654e+135,
2.193944856556020414e+136, 2.182891191249549726e+137, 3.422553976227391474e+138, 3.427139170261793325e+139, 5.407635282439279283e+140,
5.449151280716251345e+141, 8.652216451902846853e+142, 8.773133561953163468e+143, 1.401659065208261088e+145, 1.430020770598365805e+146,
2.298720866941548373e+147, 2.359534271487303458e+148, 3.815876639122970215e+149, 3.940422233383796925e+150, 6.410672753726589597e+151,
6.659313574418616571e+152, 1.089814368133520199e+154, 1.138742621225583354e+155, 1.874480713189654974e+156, 1.970024734720259290e+157,
3.261596440949999633e+158, 3.447543285760453748e+159, 5.740409736071998885e+160, 6.102151615796003911e+161, 1.021792933020815767e+163,
1.092285139227484564e+164, 1.839227279437468495e+165, 1.977036102001747166e+166, 3.347393648576192505e+167, 3.617976066663197114e+168,
6.159204313380194880e+169, 6.693255723326915013e+170, 1.145612002288716154e+172, 1.251638820262133228e+173, 2.153750564302786376e+174,
2.365597370295431427e+175, 4.092126072175294150e+176, 4.518290977264273849e+177, 7.856882058576564408e+178, 8.720301586120049762e+179,
1.524235119363853567e+181, 1.700458809293409632e+182, 2.987500833953153050e+183, 3.349903854308017046e+184, 5.915251651227242927e+185,
6.666308670072953340e+186, 1.183050330245448556e+188, 1.339928042684663648e+189, 2.389761667095806245e+190, 2.720053926649867268e+191,
4.875113800875444739e+192, 5.576110549632228346e+193, 1.004273442980341574e+195, 1.154254883773871255e+196, 2.088888761399110556e+197,
2.412392707087391051e+198, 4.386666398938132274e+199, 5.090148611954394767e+200, 9.299732765748839878e+201, 1.084201654346286125e+203,
1.990142811870251816e+204, 2.331033556844515208e+205, 4.298708473639743834e+206, 5.058342818352597530e+207, 9.371184472534641773e+208,
1.107777077219218935e+210, 2.061660583957621190e+211, 2.448187340654473858e+212, 4.576886496385918589e+213, 5.459457769659476015e+214,
1.025222575190445802e+216, 1.228377998173382119e+217, 2.317003019930407651e+218, 2.788418055853577414e+219, 5.282766885441329365e+220,
6.385477347904692419e+221, 1.215036383651505834e+223, 1.475045267365984005e+224, 2.818884410071493145e+225, 3.436855472962742787e+226,
6.596189519567294459e+227, 8.076610361462445324e+228, 1.556700726617881516e+230, 1.914156655666599567e+231, 3.704947729350557758e+232,
4.574834407043173259e+233, 8.891874550441338795e+234, 1.102535092097404599e+236, 2.151833641206804062e+237, 2.679160273796693420e+238,
5.250474084544601521e+239, 6.563942670801898683e+240, 1.291616624797971974e+242, 1.621293839688068885e+243, 3.203209229498970704e+244,
4.037021660823291842e+245, 8.008023073747426542e+246, 1.013292436866646223e+248, 2.018021814584351445e+249, 2.563629865272615084e+250,
5.125775409044252552e+251, 6.537256156445168432e+252, 1.312198504715328653e+254, 1.680074832206408217e+255, 3.385472142165548066e+256,
4.351393815414597272e+257, 8.802227569630425585e+258, 1.135713785823209891e+260, 2.306183623243171367e+261, 2.986927256715042148e+262,
6.088324765361972443e+263, 7.915357230294861520e+264, 1.619494387586284621e+266, 2.113400380488728108e+267, 4.340244958731242646e+268,
5.685047023514677946e+269, 1.171866138857435530e+271, 1.540647743372477702e+272, 3.187475897692224913e+273, 4.205968339406864190e+274,
8.733683959676696291e+275, 1.156641293336887769e+277, 2.410496772870768063e+278, 3.203896382543179168e+279, 6.701181028580735373e+280,
8.938870907295469133e+281, 1.876330688002605995e+283, 2.511822724950026798e+284, 5.291252540167348236e+285, 7.108458311608575921e+286,
1.502715721407527005e+288, 2.025910618808444061e+289, 4.297766963225527456e+290, 5.814363475980234261e+291, 1.237756885408951730e+293,
1.680351044558287812e+294, 3.589494967685960137e+295, 4.889821539664617659e+296, 1.048132530564300289e+298, 1.432717711121732956e+299,
3.081509639859043171e+300, 4.226517247809112216e+301, 9.121268533982767025e+302, 1.255275622599306442e+304, 2.718138023126864826e+305,
3.753274111571926001e+306, 8.154414069380594479e+307 }; // close dfac_double

double mirp_factorial(int n)
{
    assert(n >= 0);
    if(n <= MIRP_MAX_FAC_DBL)
        return fac_double_lut_[n];
    else // should return inf
    {
        double r = 1.0;
        for(int i = n; i > 0; i--)
            r *= i;
        return r;
    }
}


double mirp_double_factorial(int n)
{
    assert(n >= -1);

    if(n >= -1 && n <= MIRP_MAX_DFAC_DBL)
        return dfac_double_lut_[n+1];
    else // should return inf
    {
        double r = 1.0;
        for(int i = n; i > 0; i-=2)
            r *= i;
        return r;
    }
}


void mirp_double_factorial_mp(mpfr_t result, long int n)
{
    assert(n >= -1);

    /* Set the starting value */
    mpfr_set_ui(result, 1, MPFR_RNDN);

    /* Handle -1, 0, and 1 as special cases
     *
     * By definition, these all result in 1. Since result
     * was set to 1 above, we can just return
     */
    if(n >= -1 && n <= 1)
        return;

    for(long i = n; i > 0; i-=2)
        mpfr_mul_si(result, result, i, MPFR_RNDN);
}

void mirp_double_factorial_interval(arb_t result, long int n, slong working_prec)
{
    /* arblib has a double factorial function, but only for
     * positive values
     */
    
    if(n >= -1 && n <= 1)
        arb_set_ui(result, 1);
    else
        arb_doublefac_ui(result, (unsigned long)n, working_prec);
}


double mirp_binomial_coefficient(int n, int k)
{
    assert(n >= 0);
    assert(k >= 0);
    assert(k <= n);

    return mirp_factorial(n)/(mirp_factorial(k) * mirp_factorial(n-k));
}


void mirp_binomial_coefficient_mp(mpfr_t result, long int n, long int k)
{
    assert(n >= 0);
    assert(k >= 0);
    assert(k <= n);

    /* how many digits of precision are we using */
    mpfr_prec_t prec = mpfr_get_prec(result);

    /* A temporary */
    mpfr_t f;
    mpfr_init2(f, prec);

    /* put k! in the result */
    mpfr_fac_ui(result, k, MPFR_RNDN);

    /* next, (n-k)! in temporary, and multiply into result */
    mpfr_fac_ui(f, n-k, MPFR_RNDN);
    mpfr_mul(result, result, f, MPFR_RNDN);

    /* now n! in temporary, and divide */
    mpfr_fac_ui(f, n, MPFR_RNDN);
    mpfr_div(result, f, result, MPFR_RNDN);

    mpfr_clear(f);
}


void mirp_binomial_coefficient_interval(arb_t result, long int n, long int k, slong working_prec)
{
    assert(n >= 0);
    assert(k >= 0);
    assert(k <= n);

    /* A temporary */
    arb_t f;
    arb_init(f);

    /* put k! in the result */
    arb_fac_ui(result, k, working_prec);

    /* next, (n-k)! in temporary, and multiply into result */
    arb_fac_ui(f, n-k, working_prec);
    arb_mul(result, result, f, working_prec);

    /* now n! in temporary, and divide */
    arb_fac_ui(f, n, working_prec);
    arb_div(result, f, result, working_prec);

    arb_clear(f);
}

